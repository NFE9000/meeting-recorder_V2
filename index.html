<script>
class MeetingRecorder {
  constructor() {
    this.mediaRecorder = null;
    this.chunks = [];
    this.chunkTexts = [];
    this.inFlight = new Set();
    this.maxParallel = 3;
    this.currentTranscript = "";
    this.currentSummary = "";
  }

  async startRecording() {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    this.mediaRecorder = new MediaRecorder(stream, {
      mimeType: "audio/webm;codecs=opus",
      audioBitsPerSecond: 64000
    });

    this.mediaRecorder.ondataavailable = async (e) => {
      if (!e.data || e.data.size === 0) return;

      const fd = new FormData();
      fd.append("file", e.data, `chunk-${Date.now()}.webm`);
      fd.append("model", "gpt-4o-mini-transcribe");

      const task = fetch("/api/transcribe?endpoint=transcribe", {
        method: "POST",
        body: fd
      })
        .then(r => r.ok ? r.json() : r.text().then(t => { throw new Error(t); }))
        .then(json => {
          if (json?.text) this.chunkTexts.push(json.text);
        })
        .catch(err => console.error("Chunk-Transcribe-Fehler:", err))
        .finally(() => this.inFlight.delete(task));

      this.inFlight.add(task);
      if (this.inFlight.size >= this.maxParallel) {
        await Promise.race(this.inFlight);
      }
    };

    // alle 2 Minuten Chunk erzeugen
    this.mediaRecorder.start(120_000);
    console.log("Recording started...");
  }

  async stopRecording() {
    return new Promise(resolve => {
      this.mediaRecorder.onstop = async () => {
        await Promise.all([...this.inFlight]);
        this.currentTranscript = this.chunkTexts.join(" ");

        // Summary erzeugen
        await this.generateSummary(this.currentTranscript);
        // Speichern in Notion
        await this.saveToNotion();

        resolve();
      };
      this.mediaRecorder.stop();
      console.log("Recording stopped...");
    });
  }

  async generateSummary(transcript) {
    const res = await fetch("/api/transcribe?endpoint=summary", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ transcript })
    });
    const result = await res.json();
    this.currentSummary = result?.choices?.[0]?.message?.content || "";
  }

  async saveToNotion() {
    const res = await fetch("/api/api_notion", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        transcript: this.currentTranscript,
        summary: this.currentSummary,
        meetingTitle: "Meeting " + new Date().toLocaleString(),
        meetingDate: new Date().toISOString()
      })
    });
    const result = await res.json();
    console.log("Notion Response:", result);
  }
}
</script>
