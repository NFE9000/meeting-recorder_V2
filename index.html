<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meeting Recorder</title>
  <style>
    body {
      font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Helvetica Neue',Arial,sans-serif;
      background:linear-gradient(180deg,#f5f7fa 0%,#c3cfe2 100%);
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      padding:40px 20px; color:#1d1d1f;
    }
    .container {
      background:rgba(255,255,255,0.85); backdrop-filter:blur(20px);
      border-radius:24px; padding:48px; max-width:480px; width:100%;
      box-shadow:0 8px 32px rgba(0,0,0,0.06); border:1px solid rgba(255,255,255,0.2);
    }
    .header{text-align:center;margin-bottom:30px;}
    .header h1{font-size:28px;font-weight:700;margin-bottom:6px;}
    .header p{font-size:15px;color:#86868b;}
    .form-group{margin-bottom:20px;}
    label{font-weight:600;display:block;margin-bottom:6px;}
    select,input{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(0,0,0,0.1);}
    .record-section{text-align:center;margin:30px 0;}
    .record-btn{
      background:linear-gradient(135deg,#007aff 0%,#005ec4 100%);color:white;border:none;
      padding:16px 32px;border-radius:50px;font-size:16px;font-weight:600;cursor:pointer;
    }
    .record-btn.recording{background:linear-gradient(135deg,#ff3b30 0%,#d70015 100%);}
    .record-btn.processing{background:linear-gradient(135deg,#34c759 0%,#248a3d 100%);}
    .timer{font-size:24px;margin:12px 0;}
    .status{margin:12px 0;padding:12px;border-radius:8px;text-align:center;font-weight:500;}
    .status.ready{background:rgba(52,199,89,0.1);}
    .status.recording{background:rgba(255,59,48,0.1);}
    .status.processing{background:rgba(0,122,255,0.1);}
    .status.completed{background:rgba(52,199,89,0.1);}
    .status.error{background:rgba(255,59,48,0.1);}
    .debug-panel{background:#f8f8f8;border:1px solid #ddd;border-radius:8px;
      margin-top:16px;max-height:150px;overflow-y:auto;display:none;}
    .debug-toggle{font-size:13px;margin-bottom:10px;cursor:pointer;background:#eee;border:none;padding:6px 10px;border-radius:6px;}
    .debug-log{font-size:12px;padding:4px 8px;}
    .debug-log.success{color:#34c759;} .debug-log.error{color:#ff3b30;} .debug-log.info{color:#007aff;}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Meeting Recorder</h1>
      <p>Audio aufnehmen ‚Üí KI-Transkript & Notion</p>
    </div>

    <div class="form-group">
      <label for="projectSelect">Projekt ausw√§hlen</label>
      <select id="projectSelect">
        <option value="sonnenfarmen">‚òÄÔ∏è Sonnenfarmen</option>
        <option value="mikuta">üè¢ MIKUTA</option>
        <option value="heidelberger" selected>üåø Heidelberger Chlorella</option>
      </select>
    </div>

    <div class="form-group">
      <label for="meetingTitle">Meeting Titel</label>
      <input type="text" id="meetingTitle" placeholder="z.B. Quartalsbesprechung Q4">
    </div>

    <div class="record-section">
      <button id="recordBtn" class="record-btn">‚è∫ Aufnahme starten</button>
      <div id="timer" class="timer">00:00</div>
    </div>

    <div id="status" class="status ready">‚úì Bereit f√ºr Aufnahme</div>

    <button class="debug-toggle" onclick="toggleDebug()">üîç Debug Log</button>
    <div id="debugPanel" class="debug-panel"></div>
  </div>

  <script>
    let debugLogs = [];
    function addDebugLog(message,type='info'){
      const ts=new Date().toLocaleTimeString();
      debugLogs.push({ts,message,type});
      const panel=document.getElementById('debugPanel');
      const log=document.createElement('div');
      log.className=`debug-log ${type}`;
      log.textContent=`${ts} - ${message}`;
      panel.appendChild(log);panel.scrollTop=panel.scrollHeight;
    }
    function toggleDebug(){
      const panel=document.getElementById('debugPanel');
      panel.style.display=panel.style.display==='none'?'block':'none';
    }

    class MeetingRecorder {
      constructor(){
        this.recordBtn=document.getElementById('recordBtn');
        this.timer=document.getElementById('timer');
        this.status=document.getElementById('status');
        this.projectSelect=document.getElementById('projectSelect');

        this.mediaRecorder=null;
        this.chunkTexts=[]; this.inFlight=new Set(); this.maxParallel=3;
        this.isRecording=false;

        // Projektliste mit DB-IDs
        this.projects={
          sonnenfarmen:{name:"Sonnenfarmen",dbId:"f1e7db9921f24bc890910881557e4572"},
          mikuta:{name:"MIKUTA",dbId:"206078e0d6d7802f8421df3f640a7fa3"},
          heidelberger:{name:"Heidelberger Chlorella",dbId:"24f078e0d6d780e68b7cfe9ff914864d"}
        };

        this.recordBtn.addEventListener('click',()=>this.toggleRecording());
      }

      async toggleRecording(){!this.isRecording?await this.startRecording():await this.stopRecording();}

      async startRecording(){
        try{
          const stream=await navigator.mediaDevices.getUserMedia({audio:true});
          this.mediaRecorder=new MediaRecorder(stream,{mimeType:'audio/webm;codecs=opus',audioBitsPerSecond:64000});

          this.mediaRecorder.ondataavailable=async(e)=>{
            if(!e.data||e.data.size===0)return;
            const fd=new FormData(); fd.append('file',e.data,`chunk-${Date.now()}.webm`);
            fd.append('model','gpt-4o-mini-transcribe');

            const task=fetch('/api/transcribe?endpoint=transcribe',{method:'POST',body:fd})
              .then(r=>r.ok?r.json():r.text().then(t=>{throw new Error(t);}))
              .then(json=>{if(json?.text){this.chunkTexts.push(json.text);addDebugLog(`Chunk ok (+${json.text.length} Zeichen)`,'success');}})
              .catch(err=>addDebugLog(`Chunk-Fehler: ${err.message}`,'error'))
              .finally(()=>this.inFlight.delete(task));

            this.inFlight.add(task);
            if(this.inFlight.size>=this.maxParallel){await Promise.race(this.inFlight);}
          };

          this.mediaRecorder.start(120000); // alle 2 Min
          this.isRecording=true; this.startTime=Date.now();
          this.updateUI('recording'); this.startTimer();
          addDebugLog('Aufnahme gestartet (Chunk-Modus)','success');
        }catch(err){addDebugLog(`Mic-Fehler: ${err.message}`,'error');this.updateStatus('error','‚úó Mikrofonfehler');}
      }

      async stopRecording(){
        if(this.mediaRecorder && this.isRecording){
          this.mediaRecorder.stop();this.mediaRecorder.stream.getTracks().forEach(t=>t.stop());
          this.isRecording=false;this.stopTimer();this.updateUI('processing');
          addDebugLog('Aufnahme gestoppt, warte Uploads...','info');

          await Promise.all([...this.inFlight]);
          const fullTranscript=this.chunkTexts.join(' ');
          addDebugLog(`Transcript fertig (${fullTranscript.length} Zeichen)`,'success');

          const summary=await this.generateSummary(fullTranscript);
          await this.saveToNotion(fullTranscript,summary);

          this.updateUI('ready');this.updateStatus('completed','‚úì In Notion gespeichert!');
        }
      }

      async generateSummary(transcript){
        const res=await fetch('/api/transcribe?endpoint=summary',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({transcript})});
        if(!res.ok)throw new Error(await res.text());
        const result=await res.json();const raw=result?.choices?.[0]?.message?.content??'{}';
        return JSON.parse(raw);
      }

      async saveToNotion(transcript,summary){
        const projectKey=this.projectSelect.value;
        const project=this.projects[projectKey];
        const title=document.getElementById('meetingTitle').value||'Meeting';
        const now=new Date();const dateStr=now.toLocaleDateString('de-DE');const timeStr=now.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});

        const transcriptTitle=`${title} - ${dateStr} ${timeStr} - Transcript - ${project.name}`;
        await this.createNotionEntry(project.dbId,transcriptTitle,transcript,'Meeting recording Transcript');

        const summaryTitle=`${title} - ${dateStr} ${timeStr} - Summary - ${project.name}`;
        const summaryContent=this.formatSummaryContent(summary);
        await this.createNotionEntry(project.dbId,summaryTitle,summaryContent,'Meeting AI Notes');
      }

      formatSummaryContent(summary){
        let txt=`Kurze Zusammenfassung:\n${summary.short_summary}\n\n`;
        txt+=`Details:\n${summary.detailed_summary.map(i=>`‚Ä¢ ${i}`).join('\n')}\n\n`;
        txt+=`Action Items:\n${summary.action_items.map(i=>`‚òê ${i}`).join('\n')}`;
        return txt;
      }

      async createNotionEntry(dbId,title,content,status){
        const res=await fetch('/api/notion',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({dbId,title,content,status})});
        if(!res.ok)throw new Error(await res.text());
        addDebugLog(`Notion-Eintrag erstellt: ${title}`,'success');
      }

      startTimer(){this.timerInterval=setInterval(()=>{const e=Date.now()-this.startTime;const m=Math.floor(e/60000);const s=Math.floor((e%60000)/1000);this.timer.textContent=`${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;},1000);}
      stopTimer(){if(this.timerInterval){clearInterval(this.timerInterval);this.timerInterval=null;}}
      updateUI(st){if(st==='recording'){this.recordBtn.textContent='‚èπ Aufnahme stoppen';this.recordBtn.className='record-btn recording';this.updateStatus('recording','üî¥ Aufnahme l√§uft...');}
        else if(st==='processing'){this.recordBtn.textContent='‚è≥ Verarbeite...';this.recordBtn.className='record-btn processing';this.recordBtn.disabled=true;this.updateStatus('processing','ü§ñ Transkription l√§uft...');}
        else if(st==='ready'){this.recordBtn.textContent='‚è∫ Aufnahme starten';this.recordBtn.className='record-btn';this.recordBtn.disabled=false;this.updateStatus('ready','‚úì Bereit f√ºr Aufnahme');this.timer.textContent='00:00';}}
      updateStatus(type,msg){this.status.className=`status ${type}`;this.status.textContent=msg;}
    }

    document.addEventListener('DOMContentLoaded',()=>new MeetingRecorder());
  </script>
</body>
</html>
